<?php
class TBT_Rewards_Model_Observer_Sales_Convert_Quotetoorder
{
	public function __construct() { }
	
	
    /**
    * Applies the special price percentage discount
    * @param   Varien_Event_Observer $observer
    * @return  Xyz_Catalog_Model_Price_Observer
    */
    public function prepareCatalogPointsTransfers($observer)
    {
        /**/ Mage::log('quotetoorder');
        $event = $observer->getEvent();
        
        $quote = $event->getQuote();
        
        if (!$quote) {
            return $this;
        }
        $order_items = $quote->getAllItems();
        
        $catalog_transfers = Mage::getSingleton('rewards/observer_sales_catalogtransfers');
        foreach ($order_items as $item) {
            $earned_point_totals = json_decode(base64_decode($item->getEarnedPointsHash()));
            if ($earned_point_totals) {
                $catalog_transfers->addItemPoints($earned_point_totals);
            }
            
//            $redem_point_totals = json_decode(base64_decode($item->getRedeemedPointsHash()));
//            if ($redem_point_totals) {
//            	$catalog_transfers->addItemPoints($redem_point_totals);
//            }
        }
        
        $cart_redemptions = Mage::getSingleton('rewards/observer_sales_carttransfers');
        $cart_redemptions->setRedemptionRuleIds( explode(',', $quote->getCartRedemptions()) );
        
        $quote->reserveOrderId();
        $catalog_transfers->setIncrementId($quote->getReservedOrderId());
        
        return $this;
    }
}